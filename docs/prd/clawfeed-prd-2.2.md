# ClawFeed 2.2 â€” AI äº’åŠ¨åŠ©ç† (Chat Widget) PRD

> Feature 2.2 of ClawFeed v1.0 â†’ v2.0 Roadmap (Phase 2: åˆ†å‘ + äº’åŠ¨)

## 1. èƒŒæ™¯ä¸åŠ¨æœº

### ç°çŠ¶

ClawFeed å½“å‰æä¾› AI ç­–å±•çš„ Digest é˜…è¯»ä½“éªŒï¼šç”¨æˆ·æµè§ˆ 4H ç®€æŠ¥/æ—¥æŠ¥/å‘¨æŠ¥/æœˆæŠ¥ï¼Œå¯ä»¥ Mark æ”¶è—æ„Ÿå…´è¶£çš„å†…å®¹ã€‚ä½†ç”¨æˆ·ä¸å†…å®¹çš„äº’åŠ¨æ˜¯**å•å‘**çš„ â€”â€” åªèƒ½è¯»ï¼Œä¸èƒ½é—®ã€‚

### é—®é¢˜

1. **ä¿¡æ¯æ¶ˆè´¹æ·±åº¦ä¸è¶³**ï¼šDigest æ¯æ¡åªæœ‰æ ‡é¢˜+æ‘˜è¦ï¼Œç”¨æˆ·æƒ³æ·±å…¥äº†è§£æŸæ¡æ–°é—»çš„èƒŒæ™¯ã€å½±å“æˆ–æŠ€æœ¯ç»†èŠ‚æ—¶ï¼Œéœ€è¦è‡ªè¡Œæœç´¢
2. **ä¸Šä¸‹æ–‡æ–­è£‚**ï¼šç”¨æˆ·è¯»åˆ°ä¸€æ¡æ„Ÿå…´è¶£çš„å†…å®¹åç¦»å¼€ ClawFeed å»æœç´¢ï¼Œä¿¡æ¯æ¶ˆè´¹çš„è¿ç»­æ€§è¢«æ‰“æ–­
3. **è¯é¢˜è¿½è¸ªç¼ºå¤±**ï¼šç”¨æˆ·æŒç»­å…³æ³¨æŸä¸ªè¯é¢˜ï¼ˆå¦‚ "Llama 4 è¿›å±•"ï¼‰ï¼Œä½†æ²¡æœ‰æœºåˆ¶è®©ç³»ç»ŸçŸ¥é“è¿™ä¸ªåå¥½
4. **Mark åæ— å³æ—¶åé¦ˆ**ï¼šæ”¶è—åŠŸèƒ½å·²æœ‰ï¼Œä½† Deep Dive åˆ†æéœ€è¦ç­‰åå°å¤„ç†ï¼Œç¼ºå°‘å³æ—¶çš„äº¤äº’å¼æ¢ç´¢

### æœºä¼š

åœ¨ Digest é¡µé¢å†…åµŒä¸€ä¸ª AI Chat Widgetï¼Œè®©ç”¨æˆ·å¯ä»¥ï¼š
- å³æ—¶è¿½é—®å½“å‰ Digest ä¸­ä»»æ„ä¸€æ¡å†…å®¹
- è¯·æ±‚æ·±åº¦è§£è¯»ã€èƒŒæ™¯åˆ†æã€ç›¸å…³å†…å®¹æ¨è
- è¡¨è¾¾è¯é¢˜è¿½è¸ªæ„æ„¿ï¼Œä¸ºåç»­ä¸ªæ€§åŒ–æ¨èç§¯ç´¯ä¿¡å·

è¿™ä¸ ClawFeed "AI ç¼–è¾‘éƒ¨"çš„å®šä½ä¸€è‡´ â€”â€” ä¸åªæ˜¯æ¨é€å†…å®¹ï¼Œè¿˜èƒ½åƒç¼–è¾‘ä¸€æ ·å›ç­”è¯»è€…çš„è¿½é—®ã€‚

## 2. ç›®æ ‡

### æ ¸å¿ƒç›®æ ‡

- è®©ç”¨æˆ·åœ¨é˜…è¯» Digest æ—¶å¯ä»¥ä¸ AI è¿›è¡ŒåŸºäºå†…å®¹çš„å³æ—¶å¯¹è¯
- é™ä½ä¿¡æ¯æ¶ˆè´¹çš„æ‘©æ“¦ï¼šä¸€é”®å±•å¼€æŸæ¡å†…å®¹çš„æ·±åº¦åˆ†æ

### é‡åŒ–æŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡ | è¯´æ˜ |
|------|------|------|
| Chat ä½¿ç”¨ç‡ | > 15% DAU | æ¯æ—¥æ´»è·ƒç”¨æˆ·ä¸­ä½¿ç”¨è¿‡ Chat çš„æ¯”ä¾‹ |
| å¹³å‡å¯¹è¯è½®æ•° | 2-4 è½®/ä¼šè¯ | è¯´æ˜ç”¨æˆ·ç¡®å®åœ¨æ·±å…¥æ¢ç´¢ï¼Œè€Œä¸åªæ˜¯è¯•ä¸€ä¸‹ |
| Deep Dive ç‚¹å‡»ç‡ | > 10% | Digest æ¡ç›®ä¸Šçš„"æ·±åº¦åˆ†æ"æŒ‰é’®ç‚¹å‡»ç‡ |
| ç”¨æˆ·æ»¡æ„åº¦ | > 70% æœ‰ç”¨ | å¯¹è¯ç»“æŸåçš„ thumbs up/down åé¦ˆ |

### éç›®æ ‡

- **ä¸æ˜¯**é€šç”¨èŠå¤©æœºå™¨äººï¼šä»…å›´ç»•å½“æœŸ Digest å†…å®¹å¯¹è¯ï¼Œä¸å›ç­”æ— å…³é—®é¢˜
- **ä¸æ˜¯**å®æ—¶æœç´¢å¼•æ“ï¼šåŸºäºå·²é‡‡é›†çš„ Digest æ•°æ®å›ç­”ï¼Œä¸åœ¨å¯¹è¯ä¸­å®æ—¶çˆ¬å–æ–°å†…å®¹
- **ä¸åš**ç”¨æˆ·é—´ç¤¾äº¤/è®¨è®ºåŠŸèƒ½

## 3. ç”¨æˆ·æ•…äº‹

### US-1: å³æ—¶è¿½é—®

> ä½œä¸º ClawFeed ç”¨æˆ·ï¼Œæˆ‘åœ¨é˜…è¯» 4H ç®€æŠ¥æ—¶çœ‹åˆ°ä¸€æ¡å…³äº "OpenAI å‘å¸ƒæ–°æ¨¡å‹" çš„æ¶ˆæ¯ï¼Œæˆ‘æƒ³çŸ¥é“è¿™ä¸ªæ¨¡å‹å’Œä¸Šä¸€ä»£çš„åŒºåˆ«ï¼Œæˆ‘ç‚¹å‡»è¿™æ¡å†…å®¹æ—è¾¹çš„ "é—®ä¸€ä¸‹" æŒ‰é’®ï¼ŒChat Widget å¼¹å‡ºå¹¶é¢„å¡«äº†é—®é¢˜ä¸Šä¸‹æ–‡ï¼ŒAI ç»™å‡ºäº†è¯¦ç»†å¯¹æ¯”åˆ†æã€‚

### US-2: æ·±åº¦åˆ†æ

> ä½œä¸º ClawFeed ç”¨æˆ·ï¼Œæˆ‘åœ¨æ—¥æŠ¥ä¸­çœ‹åˆ°ä¸€æ¡ "æŸåˆ›ä¸šå…¬å¸èèµ„" çš„æ¶ˆæ¯ï¼Œæˆ‘ç‚¹å‡» "æ·±åº¦åˆ†æ" æŒ‰é’®ï¼ŒAI åœ¨ Chat Widget ä¸­å±•å¼€è¯¦ç»†è§£è¯»ï¼šå…¬å¸èƒŒæ™¯ã€èèµ„è½®æ¬¡ã€æŠ•èµ„æ–¹ã€å¸‚åœºåˆ†æã€ç«äº‰æ ¼å±€ç­‰ã€‚

### US-3: è¯é¢˜è¿½è¸ª

> ä½œä¸º ClawFeed ç”¨æˆ·ï¼Œæˆ‘æœ€è¿‘æŒç»­å…³æ³¨ AI Agent é¢†åŸŸçš„åŠ¨æ€ã€‚æˆ‘åœ¨ Chat ä¸­å‘Šè¯‰ AI "å¸®æˆ‘è¿½è¸ª AI Agent ç›¸å…³è¯é¢˜"ï¼Œç³»ç»Ÿè®°å½•äº†è¿™ä¸ªåå¥½ï¼Œåç»­ Digest ä¼šæé«˜è¯¥è¯é¢˜çš„æƒé‡ã€‚

### US-4: è·¨æ¡ç›®å…³è”

> ä½œä¸º ClawFeed ç”¨æˆ·ï¼Œæˆ‘åœ¨åŒä¸€æœŸ Digest ä¸­çœ‹åˆ°ä¸¤æ¡ç›¸å…³æ–°é—»ï¼ˆä¸€æ¡å…³äº GPU çŸ­ç¼ºï¼Œä¸€æ¡å…³äºè®­ç»ƒæˆæœ¬ä¼˜åŒ–ï¼‰ï¼Œæˆ‘é—® AI "è¿™ä¸¤æ¡æ–°é—»æœ‰ä»€ä¹ˆå…³è”ï¼Ÿ"ï¼ŒAI ç»¼åˆä¸¤æ¡å†…å®¹ç»™å‡ºå…³è”åˆ†æã€‚

### US-5: æœªç™»å½•ç”¨æˆ·ä½“éªŒ

> ä½œä¸ºæœªç™»å½•çš„è®¿å®¢ï¼Œæˆ‘æµè§ˆå…¬å…± Digest æ—¶ä¹Ÿèƒ½çœ‹åˆ° Chat Widgetï¼Œä½†ç‚¹å‡»åæç¤ºæˆ‘éœ€è¦ç™»å½•æ‰èƒ½ä½¿ç”¨ AI äº’åŠ¨åŠŸèƒ½ã€‚

## 4. åŠŸèƒ½éœ€æ±‚

### 4.1 Chat UI

| ID | åŠŸèƒ½ | ä¼˜å…ˆçº§ | è¯´æ˜ |
|----|------|--------|------|
| F-01 | æµ®åŠ¨æ°”æ³¡æŒ‰é’® | P0 | é¡µé¢å³ä¸‹è§’ï¼Œä¸ç°æœ‰ Feedback æŒ‰é’®å…±å­˜ï¼ˆFeedback å·¦ã€Chat å³ï¼Œæˆ–åˆå¹¶ä¸ºå¤šåŠŸèƒ½é¢æ¿ï¼‰ |
| F-02 | Chat é¢æ¿ | P0 | ç‚¹å‡»æ°”æ³¡å¼¹å‡º Chat Boxï¼ˆè¦†ç›–åœ¨é¡µé¢ä¸Šï¼Œä¸è·³è½¬ï¼‰ |
| F-03 | æ¶ˆæ¯åˆ—è¡¨ | P0 | æ”¯æŒç”¨æˆ·æ¶ˆæ¯å’Œ AI å›å¤çš„å¯¹è¯æµå±•ç¤º |
| F-04 | æµå¼è¾“å‡º | P0 | AI å›å¤ä½¿ç”¨ SSE æµå¼ä¼ è¾“ï¼Œæ‰“å­—æœºæ•ˆæœ |
| F-05 | Markdown æ¸²æŸ“ | P1 | AI å›å¤ä¸­çš„é“¾æ¥ã€ä»£ç å—ã€åˆ—è¡¨ç­‰æ­£ç¡®æ¸²æŸ“ |
| F-06 | å¯¹è¯å†å² | P1 | å½“å‰ä¼šè¯çš„å¯¹è¯è®°å½•ä¿ç•™ï¼ˆåˆ·æ–°é¡µé¢åæ¸…ç©ºæˆ–å¯é€‰ä¿ç•™ï¼‰ |
| F-07 | å¿«æ·æ“ä½œ | P1 | é¢„è®¾å¿«æ·é—®é¢˜ï¼šã€Œè§£é‡Šä¸€ä¸‹ã€ã€ŒèƒŒæ™¯æ˜¯ä»€ä¹ˆã€ã€Œç›¸å…³å†…å®¹ã€ |
| F-08 | æœ€å°åŒ–/å…³é—­ | P0 | å¯æœ€å°åŒ–å›æ°”æ³¡çŠ¶æ€ã€å¯å½»åº•å…³é—­ |

### 4.2 ä¸Šä¸‹æ–‡ç®¡ç†

| ID | åŠŸèƒ½ | ä¼˜å…ˆçº§ | è¯´æ˜ |
|----|------|--------|------|
| C-01 | Digest ä¸Šä¸‹æ–‡æ³¨å…¥ | P0 | è‡ªåŠ¨å°†å½“å‰æŸ¥çœ‹çš„ Digest å†…å®¹ä½œä¸ºå¯¹è¯ä¸Šä¸‹æ–‡ |
| C-02 | å•æ¡èšç„¦ | P0 | ç”¨æˆ·ç‚¹å‡»æŸæ¡ Digest item çš„"æ·±åº¦åˆ†æ"æ—¶ï¼Œè¯¥æ¡å†…å®¹ä½œä¸ºä¸»è¦ä¸Šä¸‹æ–‡ |
| C-03 | ä¸Šä¸‹æ–‡å¼•ç”¨ | P1 | åœ¨å¯¹è¯ä¸­å¼•ç”¨ Digest ä¸­çš„å…·ä½“æ¡ç›®ï¼ˆ"ç¬¬3æ¡è¯´çš„XXX..."ï¼‰ |
| C-04 | ä¸Šä¸‹æ–‡é•¿åº¦æ§åˆ¶ | P0 | Digest å†…å®¹ + å¯¹è¯å†å²çš„æ€» token ä¸è¶…è¿‡ LLM context window |

### 4.3 LLM é›†æˆ

| ID | åŠŸèƒ½ | ä¼˜å…ˆçº§ | è¯´æ˜ |
|----|------|--------|------|
| L-01 | å¯¹è¯æ¥å£ | P0 | åç«¯ API æ¥æ”¶ç”¨æˆ·æ¶ˆæ¯ï¼Œè°ƒç”¨ LLM è¿”å›å›å¤ |
| L-02 | System Prompt | P0 | å®šä¹‰ AI è§’è‰²ï¼ˆClawFeed ç¼–è¾‘åŠ©ç†ï¼‰ã€è¡Œä¸ºè§„åˆ™ã€å›å¤é£æ ¼ |
| L-03 | æµå¼å“åº” | P0 | SSE (Server-Sent Events) æµå¼è¿”å› LLM è¾“å‡º |
| L-04 | é€Ÿç‡é™åˆ¶ | P0 | æŒ‰ç”¨æˆ·é™åˆ¶è°ƒç”¨é¢‘ç‡ï¼ˆé˜²æ»¥ç”¨ï¼‰ |
| L-05 | è¯é¢˜è¿½è¸ªä¿¡å· | P2 | ä»å¯¹è¯ä¸­æå–ç”¨æˆ·å…´è¶£ä¿¡å·ï¼Œå†™å…¥åå¥½æ•°æ® |
| L-06 | åé¦ˆæ”¶é›† | P1 | æ¯æ¡ AI å›å¤æ”¯æŒ thumbs up/down |

### 4.4 æƒé™ä¸é™åˆ¶

| ID | åŠŸèƒ½ | ä¼˜å…ˆçº§ | è¯´æ˜ |
|----|------|--------|------|
| A-01 | ç™»å½•è¦æ±‚ | P0 | Chat åŠŸèƒ½éœ€è¦ç™»å½•ï¼ˆLLM è°ƒç”¨æœ‰æˆæœ¬ï¼‰ |
| A-02 | å…è´¹ç”¨æˆ·é™é¢ | P1 | æ¯æ—¥å¯¹è¯æ¬¡æ•°é™åˆ¶ï¼ˆå¦‚ 20 æ¡æ¶ˆæ¯/å¤©ï¼‰ |
| A-03 | æ¸¸å®¢å¼•å¯¼ | P0 | æœªç™»å½•ç”¨æˆ·ç‚¹å‡» Chat æŒ‰é’®æ—¶å¼•å¯¼ç™»å½• |

## 5. æŠ€æœ¯æ–¹æ¡ˆ

### 5.1 æ¶æ„æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 Frontend (SPA)                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚         Chat Widget (Vanilla JS)              â”‚   â”‚
â”‚  â”‚  - æµ®åŠ¨æŒ‰é’® + é¢æ¿ UI                         â”‚   â”‚
â”‚  â”‚  - SSE client æ¥æ”¶æµå¼å“åº”                     â”‚   â”‚
â”‚  â”‚  - Digest ä¸Šä¸‹æ–‡æå–                           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚ POST /api/chat  (SSE)
                   â”‚ GET  /api/chat/history
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              ClawFeed Server (Node.js)               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚            Chat Handler                       â”‚   â”‚
â”‚  â”‚  - éªŒè¯ç™»å½• + é€Ÿç‡é™åˆ¶                         â”‚   â”‚
â”‚  â”‚  - ç»„è£… context (digest + history)             â”‚   â”‚
â”‚  â”‚  - è°ƒç”¨ LLM ç«¯ç‚¹                              â”‚   â”‚
â”‚  â”‚  - SSE æµå¼è½¬å‘                                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚ HTTPS
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              LLM Endpoint                            â”‚
â”‚  æ–¹æ¡ˆ A: ClawMark Server (è‡ªæœ‰ï¼Œå¦‚å·²éƒ¨ç½²)             â”‚
â”‚  æ–¹æ¡ˆ B: ç‹¬ç«‹ LLM Proxy (OpenRouter / ç›´è¿ API)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 LLM ç«¯ç‚¹æ–¹æ¡ˆå¯¹æ¯”

#### æ–¹æ¡ˆ A: ClawMark Server

ClawMarkï¼ˆkevinho/clawmarkï¼‰å·²éƒ¨ç½²ä¸ºç‹¬ç«‹æœåŠ¡ï¼ˆè§ clawmark-digest-embed PRDï¼‰ï¼Œå¯å¤ç”¨å…¶ LLM èƒ½åŠ›ã€‚

| ç»´åº¦ | è¯¦æƒ… |
|------|------|
| ä¼˜ç‚¹ | å·²æœ‰åŸºç¡€è®¾æ–½ã€ç»Ÿä¸€ç®¡ç†ã€å…±äº« API Key |
| ç¼ºç‚¹ | ClawMark ç›®å‰ä¸“æ³¨åé¦ˆ/æ ‡æ³¨ï¼Œéœ€æ‰©å±• chat æ¥å£ï¼›å¢åŠ  ClawMark çš„è´Ÿè½½ |
| é€‚ç”¨ | ClawMark å·²è§„åˆ’ chat èƒ½åŠ›æ—¶ |

#### æ–¹æ¡ˆ B: ç‹¬ç«‹ LLM Proxy

ClawFeed Server è‡ªè¡Œå¯¹æ¥ LLM APIï¼ˆé€šè¿‡ OpenRouter æˆ–ç›´è¿ Anthropic/OpenAIï¼‰ã€‚

| ç»´åº¦ | è¯¦æƒ… |
|------|------|
| ä¼˜ç‚¹ | è§£è€¦ï¼Œä¸ä¾èµ– ClawMarkï¼›å¯çµæ´»é€‰æ¨¡å‹ï¼›ClawFeed è‡ªåŒ…å« |
| ç¼ºç‚¹ | éœ€è¦è‡ªå·±ç®¡ API Keyã€é€Ÿç‡é™åˆ¶ã€é”™è¯¯é‡è¯• |
| é€‚ç”¨ | ç‹¬ç«‹éƒ¨ç½²åœºæ™¯ã€ClawMark æœªå°±ç»ªæ—¶ |

#### æ¨èï¼šæ–¹æ¡ˆ B ä¼˜å…ˆï¼Œæ–¹æ¡ˆ A ä½œä¸ºåç»­æ•´åˆ

ç†ç”±ï¼š
1. ClawFeed é›¶å¤–éƒ¨ä¾èµ–çš„è®¾è®¡å“²å­¦ â€” ä¿æŒè‡ªåŒ…å«
2. Chat åŠŸèƒ½çš„ prompt å’Œä¸Šä¸‹æ–‡ç®¡ç†ä¸ ClawMark çš„åé¦ˆæ ‡æ³¨åœºæ™¯å·®å¼‚å¤§
3. åç»­å¯é€šè¿‡é…ç½®åˆ‡æ¢ â€”â€” `CHAT_LLM_ENDPOINT` æŒ‡å‘ ClawMark æˆ–ç‹¬ç«‹ç«¯ç‚¹

### 5.3 æ–°å¢æ•°æ®æ¨¡å‹

```sql
-- migration 011_chat.sql

CREATE TABLE IF NOT EXISTS chat_sessions (
  id TEXT PRIMARY KEY,                    -- UUID
  user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  digest_id INTEGER REFERENCES digests(id),  -- å…³è”çš„ Digestï¼ˆå¯ä¸ºç©ºè¡¨ç¤ºé€šç”¨å¯¹è¯ï¼‰
  created_at TEXT NOT NULL DEFAULT (datetime('now')),
  updated_at TEXT NOT NULL DEFAULT (datetime('now'))
);
CREATE INDEX idx_chat_sessions_user ON chat_sessions(user_id, updated_at DESC);

CREATE TABLE IF NOT EXISTS chat_messages (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  session_id TEXT NOT NULL REFERENCES chat_sessions(id) ON DELETE CASCADE,
  role TEXT NOT NULL CHECK(role IN ('user', 'assistant', 'system')),
  content TEXT NOT NULL,
  feedback TEXT CHECK(feedback IN ('up', 'down', NULL)),  -- thumbs up/down
  token_count INTEGER DEFAULT 0,
  created_at TEXT NOT NULL DEFAULT (datetime('now'))
);
CREATE INDEX idx_chat_messages_session ON chat_messages(session_id, created_at);

-- ç”¨æˆ·æ¯æ—¥ç”¨é‡è¿½è¸ª
CREATE TABLE IF NOT EXISTS chat_usage (
  user_id INTEGER NOT NULL,
  date TEXT NOT NULL,                     -- YYYY-MM-DD
  message_count INTEGER DEFAULT 0,
  token_count INTEGER DEFAULT 0,
  PRIMARY KEY(user_id, date)
);
```

### 5.4 System Prompt è®¾è®¡

```markdown
ä½ æ˜¯ ClawFeed çš„ AI ç¼–è¾‘åŠ©ç†ã€‚ä½ çš„ä»»åŠ¡æ˜¯å¸®åŠ©ç”¨æˆ·æ·±å…¥ç†è§£ä»–ä»¬æ­£åœ¨é˜…è¯»çš„æ–°é—»ç®€æŠ¥ã€‚

## è§’è‰²
- ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„ç§‘æŠ€æ–°é—»ç¼–è¾‘ï¼Œæ“…é•¿è§£è¯» AIã€åŠ å¯†è´§å¸ã€å¼€å‘å·¥å…·ç­‰é¢†åŸŸçš„åŠ¨æ€
- ä½ çš„å›ç­”åŸºäº Digest ä¸­çš„å†…å®¹ï¼Œç»“åˆä½ çš„çŸ¥è¯†è¿›è¡Œè§£è¯»å’Œåˆ†æ

## è¡Œä¸ºè§„åˆ™
1. ä»…å›´ç»•å½“å‰ Digest å†…å®¹è¿›è¡Œå¯¹è¯
2. å½“ç”¨æˆ·é—®åŠ Digest ä¹‹å¤–çš„è¯é¢˜æ—¶ï¼Œç¤¼è²Œå¼•å¯¼å› Digest å†…å®¹
3. å›ç­”è¦ç®€æ´å®ç”¨ï¼Œä½¿ç”¨ Markdown æ ¼å¼
4. æä¾›èƒŒæ™¯ã€å½±å“åˆ†æã€ç›¸å…³æ¦‚å¿µè§£é‡Šç­‰æœ‰æ·±åº¦çš„ä¿¡æ¯
5. å¦‚æœä¸ç¡®å®šï¼Œæ˜ç¡®è¯´æ˜è€Œéç¼–é€ 

## å½“å‰ Digest å†…å®¹
{digest_content}
```

### 5.5 Token é¢„ç®—ç®¡ç†

| ç»„æˆéƒ¨åˆ† | é¢„ä¼° Token | è¯´æ˜ |
|----------|-----------|------|
| System Prompt | ~200 | å›ºå®šè§’è‰²è®¾å®š |
| Digest å†…å®¹ | ~2,000-4,000 | 15-20 æ¡ Digest itemï¼ˆè§†é•¿åº¦å‹ç¼©ï¼‰ |
| å¯¹è¯å†å² | ~1,000-3,000 | ä¿ç•™æœ€è¿‘ 5-8 è½® |
| ç”¨æˆ·è¾“å…¥ | ~100-500 | å½“å‰é—®é¢˜ |
| **è¾“å…¥åˆè®¡** | ~3,300-7,700 | |
| AI å›å¤ | ~500-1,500 | è¾“å‡º |

**ç­–ç•¥**ï¼š
- ä½¿ç”¨ 128K context çš„æ¨¡å‹ï¼ˆClaude Sonnet / GPT-4o-miniï¼‰æ—¶ token é¢„ç®—å……è£•
- Digest å†…å®¹è¶…é•¿æ—¶åšæ‘˜è¦å‹ç¼©ï¼šå…ˆå‘å…¨æ–‡ï¼Œè¶…é™æ—¶æˆªæ–­ä¸ºæ ‡é¢˜+æ‘˜è¦
- å¯¹è¯å†å²è¶…è¿‡ 8 è½®æ—¶åšæ»‘åŠ¨çª—å£ï¼šä¿ç•™æœ€è¿‘ N è½® + ç¬¬ä¸€è½®ï¼ˆå«ä¸Šä¸‹æ–‡è®¾å®šï¼‰

## 6. API è®¾è®¡

### 6.1 Chat Endpoints

#### POST /api/chat

å‘èµ·å¯¹è¯æˆ–ç»§ç»­å¯¹è¯ã€‚è¿”å› SSE æµå¼å“åº”ã€‚

**è¯·æ±‚**ï¼š
```json
{
  "message": "è¿™æ¡å…³äº OpenAI çš„æ–°é—»èƒŒæ™¯æ˜¯ä»€ä¹ˆï¼Ÿ",
  "sessionId": "uuid-or-null",     // é¦–æ¬¡å¯¹è¯ä¸º nullï¼Œåç»­ä¼ å›
  "digestId": 42,                   // å½“å‰æŸ¥çœ‹çš„ Digest ID
  "itemIndex": 3                    // èšç„¦çš„ Digest æ¡ç›®åºå·ï¼ˆå¯é€‰ï¼‰
}
```

**é‰´æƒ**ï¼šéœ€è¦ç™»å½•ï¼ˆsession cookieï¼‰

**å“åº”**ï¼š`Content-Type: text/event-stream`

```
event: session
data: {"sessionId": "abc-123"}

event: delta
data: {"content": "å…³äº"}

event: delta
data: {"content": "OpenAI"}

event: delta
data: {"content": "çš„è¿™æ¡æ–°é—»..."}

event: done
data: {"messageId": 42, "tokenCount": 350}
```

**é”™è¯¯å“åº”**ï¼š
```json
{"error": "rate_limit_exceeded", "retryAfter": 60}
{"error": "not_authenticated"}
{"error": "digest_not_found"}
```

#### GET /api/chat/history

è·å–å½“å‰ç”¨æˆ·çš„å¯¹è¯å†å²ã€‚

**è¯·æ±‚å‚æ•°**ï¼š
- `sessionId` â€” æŒ‡å®šä¼šè¯
- `limit` â€” æœ€è¿‘ N æ¡æ¶ˆæ¯ï¼ˆé»˜è®¤ 50ï¼‰

**å“åº”**ï¼š
```json
{
  "session": {
    "id": "abc-123",
    "digestId": 42,
    "createdAt": "2026-02-25T10:00:00Z"
  },
  "messages": [
    {"id": 1, "role": "user", "content": "...", "createdAt": "..."},
    {"id": 2, "role": "assistant", "content": "...", "feedback": null, "createdAt": "..."}
  ]
}
```

#### POST /api/chat/feedback

å¯¹ AI å›å¤æäº¤åé¦ˆã€‚

**è¯·æ±‚**ï¼š
```json
{
  "messageId": 42,
  "feedback": "up"    // "up" | "down"
}
```

#### GET /api/chat/sessions

è·å–å½“å‰ç”¨æˆ·çš„æ‰€æœ‰ Chat ä¼šè¯åˆ—è¡¨ã€‚

**è¯·æ±‚å‚æ•°**ï¼š
- `limit` â€” é»˜è®¤ 20
- `offset` â€” åˆ†é¡µåç§»

**å“åº”**ï¼š
```json
{
  "sessions": [
    {"id": "abc-123", "digestId": 42, "lastMessage": "å…³äºOpenAI...", "updatedAt": "..."},
    {"id": "def-456", "digestId": 38, "lastMessage": "Llama 4...", "updatedAt": "..."}
  ]
}
```

### 6.2 å†…éƒ¨ LLM è°ƒç”¨

ClawFeed Server é€šè¿‡ HTTPS è°ƒç”¨ LLM APIï¼ˆä¸æš´éœ²ç»™å‰ç«¯ï¼‰ï¼š

```javascript
// é…ç½®é¡¹ï¼ˆ.envï¼‰
CHAT_LLM_PROVIDER=openrouter    // openrouter | anthropic | openai | clawmark
CHAT_LLM_API_KEY=sk-...
CHAT_LLM_MODEL=anthropic/claude-sonnet-4-20250514
CHAT_LLM_MAX_TOKENS=1500
CHAT_RATE_LIMIT=20              // æ¯ç”¨æˆ·æ¯æ—¥æ¶ˆæ¯ä¸Šé™
```

## 7. å‰ç«¯è®¾è®¡

### 7.1 Chat Widget å¸ƒå±€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                ClawFeed SPA                  â”‚
â”‚                                              â”‚
â”‚  â”Œâ”€ Digest Content â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ â˜€ï¸ 4H ç®€æŠ¥ | 2026-02-25 14:00        â”‚   â”‚
â”‚  â”‚                                       â”‚   â”‚
â”‚  â”‚ 1. OpenAI å‘å¸ƒæ–°æ¨¡å‹...     [ğŸ’¬ é—®é—®]  â”‚   â”‚
â”‚  â”‚ 2. Llama 4 benchmark å‡ºç‚‰.. [ğŸ’¬ é—®é—®]  â”‚   â”‚
â”‚  â”‚ 3. AI Agent åˆ›ä¸šå…¬å¸èèµ„... [ğŸ’¬ é—®é—®]  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                              â”‚
â”‚                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚                            â”‚  ğŸ’¬ Chat Box  â”‚  â”‚
â”‚                            â”‚              â”‚  â”‚
â”‚                            â”‚ [AIå›å¤...]   â”‚  â”‚
â”‚                            â”‚              â”‚  â”‚
â”‚                            â”‚ [è¾“å…¥æ¡†] [â†‘]  â”‚  â”‚
â”‚                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                         [ğŸ’¬] â”‚  â† æµ®åŠ¨æŒ‰é’®
â”‚                                    [ğŸ“¢]      â”‚  â† ç°æœ‰ Feedback æŒ‰é’®
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.2 UI çŠ¶æ€æœº

```
[å…³é—­çŠ¶æ€] â”€â”€ç‚¹å‡»æ°”æ³¡â”€â”€â†’ [å±•å¼€é¢æ¿]
    â†‘                        â”‚
    â”‚                   â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
    â”‚                   â†“         â†“
    â”‚              [ç©ºç™½é¢æ¿]  [æœ‰å¯¹è¯]
    â”‚                   â”‚         â”‚
    â”‚              ç”¨æˆ·è¾“å…¥    ç»§ç»­å¯¹è¯
    â”‚                   â”‚         â”‚
    â”‚                   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
    â”‚                        â†“
    â”‚                  [AI å›å¤ä¸­] â”€â”€å®Œæˆâ”€â”€â†’ [ç­‰å¾…è¾“å…¥]
    â”‚                        â”‚
    â””â”€â”€â”€â”€â”€â”€ç‚¹å‡»å…³é—­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.3 UI è§„æ ¼

| å±æ€§ | å€¼ | è¯´æ˜ |
|------|-----|------|
| é¢æ¿å°ºå¯¸ | 380 x 520px (desktop) / å…¨å± (mobile) | ç§»åŠ¨ç«¯å…¨å±å±•å¼€ |
| ä½ç½® | å³ä¸‹è§’ï¼Œè·è¾¹ç¼˜ 20px | ä¸ Feedback æŒ‰é’®é”™å¼€ |
| æ°”æ³¡æŒ‰é’® | 56 x 56px åœ†å½¢ | å›¾æ ‡ï¼šğŸ’¬ æˆ–è‡ªå®šä¹‰ SVG |
| åŠ¨ç”» | å±•å¼€/æ”¶èµ· 300ms ease-out | å¹³æ»‘è¿‡æ¸¡ |
| z-index | 9000 | ä½äº Changelog overlay (9999)ï¼Œé«˜äºå…¶ä»– |
| æš—è‰²/äº®è‰² | è·Ÿéšå…¨å±€ theme | å¤ç”¨ç°æœ‰ light/dark å˜é‡ |

### 7.4 äº¤äº’ç»†èŠ‚

**Digest æ¡ç›®ä¸Šçš„å…¥å£**ï¼š
- æ¯æ¡ Digest item å³ä¾§å¢åŠ  "ğŸ’¬" æŒ‰é’®ï¼ˆhover æ—¶æ˜¾ç¤ºï¼‰
- ç‚¹å‡»åæ‰“å¼€ Chat Widget å¹¶é¢„å¡«ä¸Šä¸‹æ–‡ï¼š"è¯·å¸®æˆ‘åˆ†æç¬¬ N æ¡ï¼š{æ ‡é¢˜}"
- ç›¸å½“äºä¸€é”®å‘èµ·é’ˆå¯¹è¯¥æ¡ç›®çš„å¯¹è¯

**å¿«æ·æ“ä½œæ **ï¼š
- Chat é¢æ¿åº•éƒ¨è¾“å…¥æ¡†ä¸Šæ–¹å±•ç¤º 3-4 ä¸ªå¿«æ·æŒ‰é’®
- é¦–æ¬¡æ‰“å¼€æ—¶ï¼šã€ŒğŸ“– æ€»ç»“æœ¬æœŸè¦ç‚¹ã€ã€ŒğŸ” æœ‰ä»€ä¹ˆå€¼å¾—å…³æ³¨çš„ã€ã€ŒğŸ“Š è¶‹åŠ¿åˆ†æã€
- èšç„¦æŸæ¡åï¼šã€ŒğŸ“– è¯¦ç»†åˆ†æã€ã€ŒğŸŒ ç›¸å…³èƒŒæ™¯ã€ã€ŒğŸ“ˆ å½±å“é¢„æµ‹ã€

**æµå¼è¾“å‡º**ï¼š
- AI å›å¤é€å­—æ˜¾ç¤ºï¼ˆSSEï¼‰ï¼Œè‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
- å›å¤å®Œæˆåæ˜¾ç¤º "ğŸ‘ ğŸ‘" åé¦ˆæŒ‰é’®
- å›å¤æœŸé—´è¾“å…¥æ¡†ç¦ç”¨ï¼Œæ˜¾ç¤º "æ€è€ƒä¸­..." çŠ¶æ€

### 7.5 ä¸ç°æœ‰ Feedback æŒ‰é’®çš„å…±å­˜æ–¹æ¡ˆ

å½“å‰å³ä¸‹è§’å·²æœ‰ Feedback æµ®åŠ¨æŒ‰é’®ã€‚ä¸¤ä¸ªæ–¹æ¡ˆï¼š

**æ–¹æ¡ˆ 1ï¼ˆæ¨èï¼‰ï¼šå¹¶æ’æ”¾ç½®**
- Chat æŒ‰é’®åœ¨å³ä¸‹è§’ï¼ˆä¸»ä½ç½®ï¼Œæ›´å¤§ï¼‰
- Feedback æŒ‰é’®åœ¨ Chat æŒ‰é’®ä¸Šæ–¹
- è§†è§‰å±‚çº§ï¼šChat > Feedback

**æ–¹æ¡ˆ 2ï¼šåˆå¹¶é¢æ¿**
- ä¸€ä¸ªæµ®åŠ¨æŒ‰é’®ï¼Œé¢æ¿å†…é¡¶éƒ¨ Tab åˆ‡æ¢ "Chat / Feedback"
- æ›´èŠ‚çœç©ºé—´ï¼Œä½†å¢åŠ äº† Feedback çš„æ“ä½œæ­¥éª¤

### 7.6 i18n

åœ¨ç°æœ‰ `I18N` å¯¹è±¡ä¸­æ–°å¢ Chat ç›¸å…³ç¿»è¯‘ï¼š

```javascript
// zh
chatTitle: 'ğŸ’¬ AI åŠ©ç†',
chatPlaceholder: 'é—®ç‚¹ä»€ä¹ˆ...',
chatSend: 'å‘é€',
chatThinking: 'æ€è€ƒä¸­...',
chatWelcome: 'ğŸ‘‹ ä½ å¥½ï¼æˆ‘æ˜¯ ClawFeed AI åŠ©ç†ã€‚ä½ å¯ä»¥é—®æˆ‘å…³äºå½“å‰ç®€æŠ¥çš„ä»»ä½•é—®é¢˜ã€‚',
chatLoginRequired: 'ç™»å½•åå³å¯ä½¿ç”¨ AI äº’åŠ¨åŠ©ç†',
chatRateLimit: 'ä»Šæ—¥å¯¹è¯æ¬¡æ•°å·²ç”¨å®Œï¼Œæ˜å¤©å†æ¥',
chatQuickSummary: 'ğŸ“– æ€»ç»“è¦ç‚¹',
chatQuickHighlight: 'ğŸ” å€¼å¾—å…³æ³¨',
chatQuickTrend: 'ğŸ“Š è¶‹åŠ¿åˆ†æ',
chatQuickAnalyze: 'ğŸ“– è¯¦ç»†åˆ†æ',
chatQuickBackground: 'ğŸŒ ç›¸å…³èƒŒæ™¯',
chatQuickImpact: 'ğŸ“ˆ å½±å“é¢„æµ‹',
chatAsk: 'ğŸ’¬',

// en
chatTitle: 'ğŸ’¬ AI Assistant',
chatPlaceholder: 'Ask something...',
chatSend: 'Send',
chatThinking: 'Thinking...',
chatWelcome: 'ğŸ‘‹ Hi! I\'m the ClawFeed AI assistant. Ask me anything about the current digest.',
chatLoginRequired: 'Sign in to use AI assistant',
chatRateLimit: 'Daily limit reached, come back tomorrow',
chatQuickSummary: 'ğŸ“– Summarize',
chatQuickHighlight: 'ğŸ” Highlights',
chatQuickTrend: 'ğŸ“Š Trends',
chatQuickAnalyze: 'ğŸ“– Deep dive',
chatQuickBackground: 'ğŸŒ Background',
chatQuickImpact: 'ğŸ“ˆ Impact',
chatAsk: 'ğŸ’¬',
```

## 8. LLM é›†æˆæ–¹æ¡ˆ

### 8.1 æ¨¡å‹é€‰æ‹©

| æ¨¡å‹ | è¾“å…¥æˆæœ¬ | è¾“å‡ºæˆæœ¬ | ç‰¹ç‚¹ | æ¨èåœºæ™¯ |
|------|---------|---------|------|---------|
| Claude Sonnet 4 | $3/M | $15/M | å¹³è¡¡æ€§èƒ½ä¸æˆæœ¬ | **é»˜è®¤æ¨è** |
| GPT-4o-mini | $0.15/M | $0.6/M | æä½æˆæœ¬ | é«˜é¢‘ä½æ·±åº¦åœºæ™¯ |
| Claude Haiku 3.5 | $0.8/M | $4/M | é€Ÿåº¦å¿«ã€æˆæœ¬ä½ | å¿«é€Ÿå›å¤åœºæ™¯ |
| Llama 3.3 70B (OpenRouter) | $0.3/M | $0.3/M | å¼€æºã€ä½æˆæœ¬ | é¢„ç®—æ•æ„Ÿ |

**æ¨èç­–ç•¥**ï¼šé»˜è®¤ä½¿ç”¨ Claude Sonnet 4ï¼ˆé€šè¿‡ OpenRouterï¼‰ï¼Œå¯é€šè¿‡é…ç½®åˆ‡æ¢ã€‚åç»­æ ¹æ®ç”¨é‡æ•°æ®ä¼˜åŒ– â€”â€” ç®€å•é—®é¢˜ï¼ˆå¿«æ·æŒ‰é’®ï¼‰ç”¨ Haiku/GPT-4o-miniï¼Œæ·±åº¦åˆ†æç”¨ Sonnetã€‚

### 8.2 æˆæœ¬ä¼°ç®—

**å‡è®¾**ï¼š
- 1,000 DAUï¼Œ15% ä½¿ç”¨ Chat = 150 ç”¨æˆ·/å¤©
- å¹³å‡ 3 è½®å¯¹è¯/ç”¨æˆ·
- æ¯è½®ï¼šè¾“å…¥ ~5,000 tokensï¼Œè¾“å‡º ~800 tokens

**å•æ—¥æˆæœ¬ï¼ˆClaude Sonnet 4ï¼‰**ï¼š
```
è¾“å…¥: 150 * 3 * 5,000 = 2.25M tokens â†’ $6.75
è¾“å‡º: 150 * 3 * 800 = 360K tokens â†’ $5.40
åˆè®¡: ~$12.15/å¤© â†’ ~$365/æœˆ
```

**å•æ—¥æˆæœ¬ï¼ˆGPT-4o-miniï¼‰**ï¼š
```
è¾“å…¥: 2.25M â†’ $0.34
è¾“å‡º: 360K â†’ $0.22
åˆè®¡: ~$0.56/å¤© â†’ ~$17/æœˆ
```

**ä¼˜åŒ–æ‰‹æ®µ**ï¼š
1. å¯¹è¯é¢‘ç‡é™åˆ¶ï¼ˆ20æ¡/å¤©/ç”¨æˆ·ï¼‰å¯æ§åˆ¶ä¸Šé™
2. Digest ä¸Šä¸‹æ–‡ç¼“å­˜ï¼šåŒä¸€ Digest çš„ä¸Šä¸‹æ–‡æå–ç»“æœå¯å¤ç”¨
3. å¿«æ·æ“ä½œä½¿ç”¨ä½æˆæœ¬æ¨¡å‹ï¼Œè‡ªç”±å¯¹è¯ä½¿ç”¨é«˜è´¨é‡æ¨¡å‹
4. Prompt cachingï¼ˆAnthropic æ”¯æŒï¼‰ï¼šé‡å¤çš„ system prompt + digest å†…å®¹å¯ç¼“å­˜ï¼Œé™ä½ ~90% è¾“å…¥æˆæœ¬

### 8.3 è°ƒç”¨é“¾è·¯

```
å‰ç«¯ POST /api/chat
    â”‚
    â”œâ”€â”€ 1. éªŒè¯ç™»å½• (session cookie)
    â”œâ”€â”€ 2. æ£€æŸ¥é€Ÿç‡é™åˆ¶ (chat_usage è¡¨)
    â”œâ”€â”€ 3. è·å– Digest å†…å®¹ (digests è¡¨)
    â”œâ”€â”€ 4. è·å–å¯¹è¯å†å² (chat_messages è¡¨, æœ€è¿‘ N è½®)
    â”œâ”€â”€ 5. ç»„è£… messages æ•°ç»„:
    â”‚       [system_prompt, digest_context, ...history, user_message]
    â”œâ”€â”€ 6. è°ƒç”¨ LLM API (streaming)
    â”‚       â”œâ”€â”€ OpenRouter: POST https://openrouter.ai/api/v1/chat/completions
    â”‚       â”œâ”€â”€ Anthropic:  POST https://api.anthropic.com/v1/messages
    â”‚       â””â”€â”€ ClawMark:   POST {CLAWMARK_URL}/api/chat
    â”œâ”€â”€ 7. æµå¼è½¬å‘ SSE åˆ°å‰ç«¯
    â”œâ”€â”€ 8. å›å¤å®Œæˆå:
    â”‚       â”œâ”€â”€ ä¿å­˜ user message åˆ° chat_messages
    â”‚       â”œâ”€â”€ ä¿å­˜ assistant message åˆ° chat_messages
    â”‚       â””â”€â”€ æ›´æ–° chat_usage è®¡æ•°
    â””â”€â”€ 9. è¿”å› done event
```

### 8.4 é”™è¯¯å¤„ç†

| åœºæ™¯ | å¤„ç†æ–¹å¼ |
|------|---------|
| LLM API è¶…æ—¶ | 15s è¶…æ—¶ï¼Œè¿”å›é”™è¯¯æç¤ºè®©ç”¨æˆ·é‡è¯• |
| LLM API ä¸å¯ç”¨ | è¿”å›å‹å¥½é”™è¯¯ï¼š"AI åŠ©ç†æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åé‡è¯•" |
| é€Ÿç‡é™åˆ¶è§¦å‘ | è¿”å› 429 + å‰©ä½™æ—¶é—´ |
| æ— æ•ˆ Digest ID | è¿”å› 404ï¼Œå‰ç«¯æç¤ºåˆ‡æ¢åˆ°æœ‰æ•ˆ Digest |
| è¾“å…¥è¿‡é•¿ | æˆªæ–­åˆ° 2,000 å­—ç¬¦ |
| æµå¼ä¸­æ–­ | å‰ç«¯æ£€æµ‹ SSE æ–­å¼€ï¼Œæ˜¾ç¤ºå·²æ¥æ”¶çš„éƒ¨åˆ† + é‡è¯•æŒ‰é’® |

## 9. éªŒæ”¶æ ‡å‡†

### åŸºç¡€åŠŸèƒ½

1. [ ] é¡µé¢å³ä¸‹è§’æ˜¾ç¤º AI Chat æµ®åŠ¨æŒ‰é’®
2. [ ] ç‚¹å‡»æŒ‰é’®å¼¹å‡º Chat é¢æ¿ï¼Œæ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯
3. [ ] ç”¨æˆ·è¾“å…¥æ¶ˆæ¯å¹¶å‘é€ï¼ŒAI æµå¼è¿”å›å›å¤
4. [ ] AI å›å¤åŸºäºå½“å‰ Digest å†…å®¹å›ç­”ï¼ˆéé€šç”¨èŠå¤©ï¼‰
5. [ ] å¯¹è¯å†å²åœ¨é¢æ¿å†…ä¿æŒï¼ˆåŒä¸€ä¼šè¯å†…ï¼‰
6. [ ] é¢æ¿å¯æœ€å°åŒ–å›æ°”æ³¡çŠ¶æ€
7. [ ] æš—è‰²/äº®è‰²ä¸»é¢˜è·Ÿéšå…¨å±€åˆ‡æ¢
8. [ ] ä¸­è‹±æ–‡ i18n æ­£ç¡®

### Digest é›†æˆ

9. [ ] Digest æ¡ç›®æ—æ˜¾ç¤º"ğŸ’¬"å¿«æ·å…¥å£
10. [ ] ç‚¹å‡»æ¡ç›®å…¥å£å Chat é¢æ¿æ‰“å¼€å¹¶é¢„å¡«ä¸Šä¸‹æ–‡
11. [ ] Chat é¢æ¿é¡¶éƒ¨æ˜¾ç¤ºå½“å‰å…³è”çš„ Digest ä¿¡æ¯
12. [ ] å¿«æ·æ“ä½œæŒ‰é’®å¯ç”¨ä¸”æ­£ç¡®è§¦å‘å¯¹è¯

### æƒé™ä¸é™åˆ¶

13. [ ] æœªç™»å½•ç”¨æˆ·ç‚¹å‡» Chat æŒ‰é’®æç¤ºç™»å½•
14. [ ] é€Ÿç‡é™åˆ¶ç”Ÿæ•ˆï¼šè¶…å‡ºæ¯æ—¥é™é¢æ—¶è¿”å›å‹å¥½æç¤º
15. [ ] ä¸æ³„éœ² LLM API Keyï¼ˆæ‰€æœ‰è°ƒç”¨ç»åç«¯ä»£ç†ï¼‰

### è´¨é‡ä¸æ€§èƒ½

16. [ ] AI é¦– token å“åº”æ—¶é—´ < 2sï¼ˆæ’é™¤ç½‘ç»œå»¶è¿Ÿï¼‰
17. [ ] æµå¼è¾“å‡ºæµç•…æ— å¡é¡¿
18. [ ] Markdown æ ¼å¼æ­£ç¡®æ¸²æŸ“ï¼ˆé“¾æ¥ã€åˆ—è¡¨ã€ä»£ç å—ï¼‰
19. [ ] ç§»åŠ¨ç«¯ Chat é¢æ¿å…¨å±å±•å¼€ï¼Œå¯æ­£å¸¸ä½¿ç”¨
20. [ ] Chat åŠŸèƒ½ä¸å½±å“ ClawFeed å·²æœ‰åŠŸèƒ½ï¼ˆDigest åˆ—è¡¨ã€ç™»å½•ã€Sourcesã€Marksã€Feedbackï¼‰

### åé¦ˆ

21. [ ] æ¯æ¡ AI å›å¤ä¸‹æ–¹æœ‰ thumbs up/down æŒ‰é’®
22. [ ] åé¦ˆæ•°æ®å†™å…¥æ•°æ®åº“

## 10. ä¾èµ–å…³ç³»

### å‰ç½®ä¾èµ–

| ä¾èµ– | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| ç”¨æˆ·è®¤è¯ç³»ç»Ÿ | å·²å®Œæˆ | Google OAuthï¼Œsession cookie |
| Digest æ•°æ® | å·²å®Œæˆ | `GET /api/digests/:id` è¿”å›å®Œæ•´å†…å®¹ |
| å‰ç«¯ SPA æ¡†æ¶ | å·²å®Œæˆ | Vanilla JSï¼Œå¯ç›´æ¥æ‰©å±• |
| Feedback æµ®åŠ¨æŒ‰é’® | å·²å®Œæˆ | éœ€è°ƒæ•´ä½ç½®ä»¥ä¸ Chat æŒ‰é’®å…±å­˜ |

### å¤–éƒ¨ä¾èµ–

| ä¾èµ– | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| LLM API (OpenRouter / Anthropic / OpenAI) | å¿…é¡» | è‡³å°‘ä¸€ä¸ª LLM ç«¯ç‚¹ |
| API Key | å¿…é¡» | `.env` ä¸­é…ç½® `CHAT_LLM_API_KEY` |

### ä¸‹æ¸¸å½±å“

| åŠŸèƒ½ | å½±å“ |
|------|------|
| 2.4 Digest è´¨é‡æå‡ï¼ˆè¯é¢˜è¿½è¸ªï¼‰ | Chat å¯¹è¯äº§ç”Ÿçš„ç”¨æˆ·å…´è¶£ä¿¡å·å¯åé¦ˆåˆ° Digest ä¸ªæ€§åŒ– |
| 2.3 Mark å¢å¼ºï¼ˆDeep Diveï¼‰ | Chat çš„æ·±åº¦åˆ†æèƒ½åŠ›å¯å¤ç”¨åˆ° Mark çš„ AI è§£è¯» |
| 3.1 Agent Friendly API | Chat æ¥å£çš„è®¾è®¡å¯ä¸ºåç»­ MCP/Agent å¯¹è¯æä¾›åŸºç¡€ |

### æ–°å¢é…ç½®é¡¹

```env
# .env æ–°å¢
CHAT_LLM_PROVIDER=openrouter        # openrouter | anthropic | openai | clawmark
CHAT_LLM_API_KEY=sk-or-v1-xxx       # LLM API Key
CHAT_LLM_MODEL=anthropic/claude-sonnet-4-20250514
CHAT_LLM_MAX_TOKENS=1500            # å•æ¬¡å›å¤æœ€å¤§ token
CHAT_RATE_LIMIT=20                   # æ¯ç”¨æˆ·æ¯æ—¥æ¶ˆæ¯ä¸Šé™
CHAT_ENABLED=true                    # æ€»å¼€å…³
```

### æ¶‰åŠæ–‡ä»¶

| æ–‡ä»¶ | å˜æ›´ |
|------|------|
| `migrations/011_chat.sql` | æ–°å¢ chat_sessions, chat_messages, chat_usage è¡¨ |
| `src/db.mjs` | æ–°å¢ chat ç›¸å…³ CRUD å‡½æ•° |
| `src/server.mjs` | æ–°å¢ `/api/chat`, `/api/chat/history`, `/api/chat/feedback`, `/api/chat/sessions` ç«¯ç‚¹ |
| `web/index.html` | æ–°å¢ Chat Widget UI + CSS + JS |
| `.env.example` | æ–°å¢ CHAT_* é…ç½®é¡¹ |
| `templates/chat-system-prompt.md` | æ–°å¢ System Prompt æ¨¡æ¿ |

## 11. é£é™©ä¸å¼€æ”¾é—®é¢˜

### é£é™©

| é£é™© | å½±å“ | ç¼“è§£æªæ–½ |
|------|------|---------|
| LLM æˆæœ¬è¶…é¢„æœŸ | è´¢åŠ¡å‹åŠ› | é€Ÿç‡é™åˆ¶ + ä½æˆæœ¬æ¨¡å‹å…œåº• + prompt caching |
| LLM å¹»è§‰/é”™è¯¯å›ç­” | ç”¨æˆ·ä¿¡ä»»å—æŸ | System prompt çº¦æŸ + ä»…åŸºäº Digest å†…å®¹å›ç­” + åé¦ˆæœºåˆ¶ |
| å‰ç«¯ä»£ç è†¨èƒ€ | SPA å·² 1,768 è¡Œï¼Œç»§ç»­å¢é•¿ç»´æŠ¤å›°éš¾ | Chat Widget ä½œä¸ºç‹¬ç«‹ JS æ¨¡å—ï¼Œå‡½æ•°å‰ç¼€éš”ç¦» `chat_*` |
| SSE åœ¨æŸäº›ä»£ç†/CDN åä¸ç¨³å®š | æµå¼è¾“å‡ºå¤±è´¥ | é™çº§æ–¹æ¡ˆï¼šéæµå¼ (polling) æ¨¡å¼ä½œä¸º fallback |
| æ»¥ç”¨ï¼ˆæ¶æ„ç”¨æˆ·å¤§é‡è°ƒç”¨ï¼‰ | æˆæœ¬å¤±æ§ | IP é™åˆ¶ + ç”¨æˆ·é™åˆ¶ + API Key ç›‘æ§ |
| LLM ç«¯ç‚¹ä¸å¯ç”¨ | åŠŸèƒ½ç˜«ç—ª | Chat æŒ‰é’®éšè—æˆ–æ˜¾ç¤º"æš‚ä¸å¯ç”¨"ï¼Œä¸å½±å“æ ¸å¿ƒ Digest é˜…è¯» |

### å¼€æ”¾é—®é¢˜

| # | é—®é¢˜ | é€‰é¡¹ | å»ºè®® |
|---|------|------|------|
| Q1 | Chat å¯¹è¯è®°å½•æ˜¯å¦è·¨ Digest æŒä¹…åŒ–ï¼Ÿ | A) æ¯æ¬¡åˆ‡æ¢ Digest é‡ç½® B) æŒä¹…ä¿ç•™æ‰€æœ‰å†å² | **å»ºè®® A**ï¼šç®€åŒ–å®ç°ï¼Œé¿å…ä¸Šä¸‹æ–‡æ··ä¹± |
| Q2 | å…è´¹ç”¨æˆ·æ¯æ—¥æ¶ˆæ¯ä¸Šé™å®šå¤šå°‘ï¼Ÿ | A) 10æ¡ B) 20æ¡ C) 50æ¡ | **å»ºè®® B**ï¼šå¹³è¡¡ä½“éªŒä¸æˆæœ¬ |
| Q3 | é»˜è®¤ä½¿ç”¨å“ªä¸ª LLM æ¨¡å‹ï¼Ÿ | A) Claude Sonnet B) GPT-4o-mini C) Haiku | **å»ºè®® A**ï¼šè´¨é‡ä¼˜å…ˆï¼Œåç»­æŒ‰æ•°æ®ä¼˜åŒ– |
| Q4 | è¯é¢˜è¿½è¸ªä¿¡å·ä½•æ—¶å®ç°ï¼Ÿ | 2.2 ä¸€èµ·åš / å»¶ååˆ° 2.4 | **å»ºè®®å»¶ååˆ° 2.4**ï¼š2.2 èšç„¦ Chat åŸºç¡€åŠŸèƒ½ |
| Q5 | Chat Widget ä¸ Feedback æŒ‰é’®çš„å…±å­˜æ–¹å¼ï¼Ÿ | å¹¶æ’ / åˆå¹¶é¢æ¿ | **å»ºè®®å¹¶æ’**ï¼šå„è‡ªç‹¬ç«‹ï¼Œä¸äº’ç›¸å¹²æ‰° |
| Q6 | æ˜¯å¦æ”¯æŒå›¾ç‰‡/æ–‡ä»¶è¾“å…¥ï¼Ÿ | æ”¯æŒ / ä¸æ”¯æŒ | **å»ºè®® v1 ä¸æ”¯æŒ**ï¼šçº¯æ–‡æœ¬å¯¹è¯ï¼Œåç»­è¿­ä»£ |

## 12. å®æ–½è®¡åˆ’

### Phase 1: åŸºç¡€å¯¹è¯ (MVP)
- Chat Widget UIï¼ˆæ°”æ³¡ã€é¢æ¿ã€æ¶ˆæ¯åˆ—è¡¨ï¼‰
- åç«¯ `/api/chat` ç«¯ç‚¹ + SSE æµå¼
- Digest ä¸Šä¸‹æ–‡æ³¨å…¥
- ç™»å½•éªŒè¯ + é€Ÿç‡é™åˆ¶
- æš—è‰²/äº®è‰²ä¸»é¢˜ + i18n

### Phase 2: é›†æˆå¢å¼º
- Digest æ¡ç›®æ— "ğŸ’¬" å¿«æ·å…¥å£
- å¿«æ·æ“ä½œæŒ‰é’®
- åé¦ˆæ”¶é›† (thumbs up/down)
- å¯¹è¯å†å²æŒä¹…åŒ–

### Phase 3: ä¼˜åŒ–è¿­ä»£
- Prompt caching é™æˆæœ¬
- æ¨¡å‹åˆ†å±‚ç­–ç•¥ï¼ˆç®€å•/å¤æ‚é—®é¢˜ç”¨ä¸åŒæ¨¡å‹ï¼‰
- è¯é¢˜è¿½è¸ªä¿¡å·æå–ï¼ˆè¡”æ¥ 2.4ï¼‰
- æ€§èƒ½ç›‘æ§ + è´¨é‡åˆ†æ dashboard

---

*Generated by Jessie -- 2026-02-25*
