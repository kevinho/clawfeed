name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - run: npm ci
      - run: npx eslint src/

  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - run: npm ci
      - name: Start server & run e2e tests
        run: |
          # Create data directory and test DB
          mkdir -p data
          node -e "
            const { createRequire } = require('module');
            const require2 = createRequire(process.cwd() + '/');
            const Database = require2('better-sqlite3');
            const fs = require('fs');
            const path = require('path');
            const db = new Database('data/test.db');
            const migrationsDir = path.join(process.cwd(), 'migrations');
            const files = fs.readdirSync(migrationsDir).filter(f => f.endsWith('.sql')).sort();
            for (const f of files) {
              db.exec(fs.readFileSync(path.join(migrationsDir, f), 'utf8'));
            }
            db.close();
          "

          # Load test seed data (users, sessions, digests)
          sqlite3 data/test.db < test/seed.sql

          # Start server in background
          DIGEST_DB=data/test.db DIGEST_PORT=8767 API_KEY=test-key-ci \
            SESSION_SECRET=test-secret-ci \
            node src/server.mjs &
          SERVER_PID=$!

          # Wait for server (fail if not ready in 15s)
          SERVER_READY=false
          for i in $(seq 1 15); do
            if curl -sf http://localhost:8767/api/health > /dev/null 2>&1; then
              SERVER_READY=true
              break
            fi
            sleep 1
          done
          if [ "$SERVER_READY" != "true" ]; then
            echo "ERROR: Server failed to start within 15s"
            kill $SERVER_PID 2>/dev/null || true
            exit 1
          fi

          # Run e2e tests against local server
          AI_DIGEST_API=http://localhost:8767/api \
            AI_DIGEST_FEED=http://localhost:8767/feed \
            AI_DIGEST_DB=data/test.db \
            API_KEY=test-key-ci \
            bash test/e2e.sh

          kill $SERVER_PID 2>/dev/null || true

  audit:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - run: npm audit --omit=dev || true
